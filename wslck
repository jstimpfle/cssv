#!/usr/bin/python3

import sys
import wsl.parse
import wsl.format
import wsl.schema
import wsl.integrity

if __name__ == '__main__':
    schemafile = None

    args = sys.argv[1:]
    if len(args) >= 2 and args[0] == '--schema-file':
        schemafile = args[1]
        args = args[2:]
    if args:
        raise Exception('Unconsumed arguments:', args)

    if schemafile:
        with open(schemafile, 'rb') as f:
            schemastring = f.read()
    else:
        schemastring = None

    lines = iter(sys.stdin.buffer)
    schema, tables = wsl.parse.parse_db(lines, schemastring, datatype_parsers=None)
    wsl.integrity.check_integrity(schema, tables)
    
    txt = wsl.format.format_db(schema, tables)
    sys.stdout.buffer.write(txt)
    sys.stdout.buffer.flush()
