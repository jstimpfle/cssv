#!/usr/bin/python3

import sys
import wsl.integrity
import wsl.parser
import wsl.schema

if __name__ == '__main__':
    schemafile = None

    args = sys.argv[1:]
    if len(args) >= 2 and args[0] == '--schema-file':
        schemafile = args[1]
        args = args[2:]
    if args:
        raise Exception('Unconsumed arguments:', args)

    ahead = wsl.parser.Ahead(sys.stdin.buffer)
    if schemafile:
        with open(schemafile, 'rb') as f:
            schemastring = f.read()
        schema = wsl.schema.parse_schema(schemastring)
    else:
        hdr = wsl.parser.split_header(ahead)
        schema = wsl.schema.parse_schema(hdr)

    datatypes_of_relation = wsl.schema.make_datatypes_of_relation(schema)
    tuples_of_relation = dict()
    for relation in schema.relations:
        tuples_of_relation[relation] = []
    for line in ahead:
        line = line.strip()
        if line:
            r, tup = wsl.parser.parse_row(line, datatypes_of_relation)
            tuples_of_relation[r].append(tup)
    wsl.integrity.check_integrity(schema, tuples_of_relation)
    print(tuples_of_relation)
